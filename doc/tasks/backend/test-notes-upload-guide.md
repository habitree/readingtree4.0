# 기록 생성 및 이미지 업로드 테스트 가이드

**작성일:** 2025년 12월  
**목적:** 기록 생성과 이미지 업로드 기능의 브라우저 테스트 가이드

---

## 사전 준비

### 1. 개발 서버 실행 확인
```bash
npm run dev
```
서버가 `http://localhost:3000`에서 실행 중인지 확인합니다.

### 2. 환경 변수 확인
다음 환경 변수가 설정되어 있는지 확인:
- `SUPABASE_URL`
- `SUPABASE_ANON_KEY`
- `GEMINI_API_KEY` (OCR 테스트 시 필요)

### 3. 로그인 상태 확인
테스트를 위해 먼저 로그인해야 합니다.

---

## 테스트 시나리오

### 시나리오 1: 기록 생성 (텍스트 필사)

1. **로그인**
   - `http://localhost:3000/login` 접속
   - 카카오톡 또는 구글로 로그인

2. **책 추가 (필요한 경우)**
   - `http://localhost:3000/books/search` 접속
   - 책 검색 후 추가
   - 추가된 책의 ID 확인

3. **기록 작성 페이지 접속**
   - `http://localhost:3000/notes/new?bookId={bookId}` 접속
   - `{bookId}`는 실제 user_books 테이블의 ID

4. **기록 작성**
   - 기록 유형: "필사" 선택
   - 텍스트 입력
   - 페이지 번호 입력 (선택)
   - 태그 입력 (선택)
   - "저장" 버튼 클릭

5. **결과 확인**
   - 성공 메시지 확인
   - 책 상세 페이지로 리다이렉트 확인
   - 기록 목록에 새 기록 표시 확인

---

### 시나리오 2: 이미지 업로드 및 기록 생성

1. **기록 작성 페이지 접속**
   - `http://localhost:3000/notes/new?bookId={bookId}` 접속

2. **이미지 업로드**
   - 기록 유형: "사진" 또는 "필사 이미지" 선택
   - "이미지 선택" 버튼 클릭
   - 이미지 파일 선택 (jpg, png, webp, heic)
   - 업로드 진행 상태 확인

3. **파일 크기 테스트**
   - 5MB 이하 파일: 정상 업로드 확인
   - 5MB 초과 파일: 자동 압축 확인

4. **기록 저장**
   - 이미지 업로드 완료 후
   - 추가 정보 입력 (선택)
   - "저장" 버튼 클릭

5. **결과 확인**
   - 이미지가 Supabase Storage에 업로드되었는지 확인
   - 기록에 이미지 URL이 저장되었는지 확인
   - 이미지가 정상적으로 표시되는지 확인

---

### 시나리오 3: OCR 처리 테스트

1. **필사 이미지 기록 생성**
   - 기록 유형: "필사 이미지" 선택
   - 이미지 업로드 (텍스트가 포함된 이미지)
   - 기록 저장

2. **OCR 처리 확인**
   - 기록 저장 후 자동으로 OCR 요청이 전송되는지 확인
   - 브라우저 개발자 도구 Network 탭에서 `/api/ocr` 호출 확인
   - 즉시 응답 확인 (비동기 처리)

3. **OCR 결과 확인**
   - 몇 초 후 기록 상세 페이지에서 OCR 결과 확인
   - `content` 필드에 추출된 텍스트가 저장되었는지 확인

---

## API 엔드포인트 직접 테스트

### 1. 이미지 업로드 API 테스트

**cURL 명령어:**
```bash
curl -X POST http://localhost:3000/api/upload \
  -H "Cookie: {세션 쿠키}" \
  -F "file=@/path/to/image.jpg" \
  -F "type=photo"
```

**예상 응답:**
```json
{
  "url": "https://[project].supabase.co/storage/v1/object/public/images/photos/[userId]/[timestamp]-[random].jpg"
}
```

### 2. OCR 요청 API 테스트

**cURL 명령어:**
```bash
curl -X POST http://localhost:3000/api/ocr \
  -H "Cookie: {세션 쿠키}" \
  -H "Content-Type: application/json" \
  -d '{
    "noteId": "note-id",
    "imageUrl": "https://[image-url]"
  }'
```

**예상 응답:**
```json
{
  "success": true,
  "noteId": "note-id"
}
```

---

## 확인 사항

### 이미지 업로드
- [ ] 파일 크기 제한 (5MB) 작동 확인
- [ ] 5MB 초과 시 자동 압축 작동 확인
- [ ] 지원 파일 형식 (jpg, png, webp, heic) 업로드 확인
- [ ] 업로드 경로 형식 확인: `${type}s/${userId}/${fileName}`
- [ ] 에러 메시지 확인 (잘못된 파일 형식, 크기 초과 등)

### 기록 생성
- [ ] 책 소유 확인 작동 확인
- [ ] 기록 생성 성공 확인
- [ ] 이미지 URL 저장 확인
- [ ] 페이지 번호 저장 확인
- [ ] 태그 저장 확인

### OCR 처리
- [ ] OCR 요청 즉시 응답 확인
- [ ] 백그라운드 처리 확인
- [ ] OCR 결과 저장 확인
- [ ] 한글 텍스트 인식 확인

---

## 문제 해결

### 이미지 업로드 실패
1. 파일 크기 확인 (5MB 이하 권장)
2. 파일 형식 확인 (jpg, png, webp, heic만 지원)
3. Supabase Storage 설정 확인
4. 브라우저 개발자 도구 Network 탭에서 에러 확인

### OCR 처리 실패
1. GEMINI_API_KEY 환경 변수 확인
2. 이미지 URL 접근 가능 여부 확인
3. 서버 로그에서 에러 메시지 확인
4. Gemini API 할당량 확인

### 기록 생성 실패
1. 로그인 상태 확인
2. 책 소유 확인 (user_books 테이블)
3. 필수 필드 입력 확인
4. 브라우저 개발자 도구 Console 탭에서 에러 확인

---

## 테스트 체크리스트

### 기본 기능
- [ ] 텍스트 필사 기록 생성
- [ ] 이미지 업로드 (5MB 이하)
- [ ] 이미지 업로드 (5MB 초과 - 자동 압축)
- [ ] 사진 기록 생성
- [ ] 필사 이미지 기록 생성
- [ ] OCR 처리 요청
- [ ] OCR 결과 확인

### 에러 처리
- [ ] 잘못된 파일 형식 업로드 시 에러 메시지
- [ ] 파일 크기 초과 시 에러 메시지
- [ ] 책 소유하지 않은 경우 에러 메시지
- [ ] 로그인하지 않은 경우 리다이렉트

### UI/UX
- [ ] 이미지 업로드 진행 상태 표시
- [ ] OCR 처리 중 상태 표시
- [ ] 성공/실패 토스트 메시지
- [ ] 로딩 상태 표시

---

**문서 끝**

