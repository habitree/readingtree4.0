# 데이터 마이그레이션 계획서 (Data Migration Plan)

**프로젝트:** Habitree Reading Hub v4.0.0  
**작성일:** 2026년 1월 12일  
**상태:** 초안 (사용자 검토 필요)

---

## 1. 개요 (Overview)

본 문서는 이전 시스템에서 사용하던 독서 데이터(사용자, 도서, 기록 등)를 현재의 **Habitree Reading Hub v4.0.0** 시스템으로 안전하게 마이그레이션하기 위한 기술적/절차적 계획을 정의합니다.

### 1.1 마이그레이션 목표
- 기존 사용자의 기록 및 독서 상태 유지
- 도서 정보의 무결성 확보 및 중복 제거
- 기록(메모, 인용구)과 이미지 데이터의 안정적인 이관

---

## 2. 데이터 요구사항 및 매핑 (Data Mapping)

현재 시스템의 주요 테이블 구조에 따른 데이터 매핑 전략입니다.

### 2.1 사용자 (Users)
- **원본 데이터**: 이전 시스템의 사용자 ID, 이메일, 이름
- **대상 테이블**: `users`
- **전략**: 
    - Supabase Auth를 통한 계정 생성이 선행되어야 함
    - 이전 시스템의 ID와 Supabase Auth UID를 연결하는 매핑 테이블 활용

### 2.2 도서 (Books)
- **원본 데이터**: ISBN, 제목, 저자, 출판사, 표지 이미지
- **대상 테이블**: `books`
- **전략**:
    - **ISBN 기준 중복 제거**: 이미 동일한 ISBN이 존재하면 기존 `book_id` 사용
    - **이미지 최적화**: 이전 시스템의 이미지 링크 유효성 확인 및 필요시 재수집

### 2.3 서재 및 독서 상태 (Bookshelves & UserBooks)
- **원본 데이터**: 사용자가 읽은 책, 현재 상태(읽는 중, 완독 등), 읽기 시작일/완독일
- **대상 테이블**: `bookshelves`, `user_books`
- **전략**:
    - 이관 시 모든 사용자는 기본적으로 하나의 '메인 서재'를 생성하고 할당함
    - `user_books` 테이블에 이전 독서 이력 주입

### 2.4 기록 (Notes & Transcriptions)
- **원본 데이터**: 인용구, 생각(메모), 페이지 번호, 사진, 생성일
- **대상 테이블**: `notes`, `transcriptions`
- **전략**:
    - 일반 메모와 사진 기록은 `notes` 테이블로 이관
    - OCR 필사 기록은 `notes`와 `transcriptions` 테이블로 분리하여 저장

---

## 3. 마이그레이션 단계 (Migration Steps)

### 1단계: 데이터 정리 및 추출 (Organize & Extract)
1. **데이터 추출**: 이전 시스템에서 데이터를 CSV 또는 JSON 형식으로 추출합니다.
2. **데이터 정제**: 
    - 비정상적인 문자 제거
    - 필수 값(제목 등) 누락 확인
    - 날짜 형식 통일 (ISO 8601)

### 2단계: 데이터 변환 (Transform)
- 추출된 데이터를 Supabase API 또는 SQL Insert 문 형식으로 변환합니다.
- 외래 키 관계(User -> Book -> Note)를 일관성 있게 재구성합니다.

### 3단계: 테스트 마이그레이션 (Test Run)
- 개발 환경(Staging)에서 소규모 샘플 데이터를 사용하여 주입 테스트를 수행합니다.
- 데이터 손실이나 인덱스 오류가 없는지 검증합니다.

### 4단계: 전체 데이터 주입 (Execution)
- 운영 환경(Production)에서 정제된 전체 데이터를 일괄 주입합니다.
- `revalidatePath` 등을 통해 캐시를 갱신합니다.

### 5단계: 검증 (Verification)
- 사용자별로 데이터가 정확히 노출되는지 최종 확인합니다.

---

## 4. 사용자 협조 사항 (Action Items for User)

> [!IMPORTANT]
> 원활한 계획 수립을 위해 다음 정보가 필요합니다:
> 1. **이전 데이터의 형식**: (예: MySQL 덤프, Excel 파일, JSON 등)
> 2. **사용자 규모**: 약 몇 명의 사용자 데이터인지?
> 3. **이미지 데이터**: 사진 기록의 이미지가 별도의 스토리지(S3 등)에 있는지, 아니면 URL 형태인지?

---

### 5. 향후 일정
- [ ] 1차 계획서 승인
- [ ] 샘플 데이터 제공 및 구조 분석
- [ ] 마이그레이션 스크립트 작성
- [ ] 최종 마이그레이션 수행
