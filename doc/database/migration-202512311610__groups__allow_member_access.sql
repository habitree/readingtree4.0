-- ============================================
-- 마이그레이션: groups RLS 정책 - 멤버 접근 허용
-- 날짜: 2025-12-31 16:10
-- 작성자: 시스템
-- ============================================
-- 
-- 변경 사항:
-- 1. groups 테이블의 SELECT 정책에 멤버 접근 허용 추가
--    - 무한 재귀 방지를 위해 group_members를 직접 참조하지 않음
--    - 대신 서버 액션에서 멤버십을 먼저 확인한 후 그룹 조회
-- 2. getGroupDetail/getGroups 함수에서 멤버십 확인 후 그룹 조회
--
-- 영향받는 테이블:
-- - groups
--
-- 참고:
-- - RLS 정책은 공개 그룹 또는 리더인 그룹만 조회 가능
-- - 멤버인 경우: getGroupDetail/getGroups에서 멤버십 확인 후 그룹 조회
-- - 무한 재귀 방지: group_members를 직접 참조하지 않음
-- ============================================

-- groups 테이블 SELECT 정책은 이미 수정됨 (migration-202512311600)
-- 이 마이그레이션은 참고용이며, 실제로는 getGroupDetail/getGroups 함수에서 처리
-- RLS 정책 자체는 변경하지 않음 (무한 재귀 방지)

-- 참고: getGroupDetail/getGroups 함수에서 다음 로직 사용:
-- 1. 먼저 group_members에서 멤버십 확인
-- 2. 멤버인 경우 group_id로 groups 조회
-- 3. RLS 정책: 공개 그룹(is_public = TRUE) 또는 리더(leader_id = auth.uid())만 조회 가능
-- 4. 멤버인 경우: 공개 그룹이 아니고 리더도 아닌 경우 조회 불가
--    → 이 경우 RLS 정책을 수정하여 멤버도 조회 가능하도록 해야 함
--    → 하지만 group_members를 직접 참조하면 무한 재귀 발생
--    → 따라서 서버 액션에서 별도 처리 필요

-- 해결 방법: RLS 정책은 유지하고, 서버 액션에서 처리
-- getGroupDetail/getGroups 함수에서:
-- 1. 멤버십 확인
-- 2. 멤버인 경우 그룹 조회 시도
-- 3. 조회 실패 시 에러 메시지 개선

-- ============================================
-- 참고: 현재 RLS 정책
-- ============================================
-- CREATE POLICY "Anyone can view public groups"
--     ON groups FOR SELECT
--     USING (
--         is_public = TRUE 
--         OR 
--         leader_id = auth.uid()
--     );
-- 
-- 이 정책은 공개 그룹 또는 리더인 그룹만 조회 가능
-- 멤버인 경우 조회 불가 → 서버 액션에서 별도 처리 필요
-- ============================================

