# OCR 이미지 URL 오류 처리 개선

## 개요

OCR 배치 처리 중 발생하는 이미지 URL 오류를 더 명확하게 처리하고 사용자에게 친화적인 오류 메시지를 제공하도록 개선했습니다.

## 문제 상황

### 발생한 오류

```
[Cloud Run OCR] OCR 처리 실패: 이미지 다운로드 실패: 404 Not Found
```

**원인:**
- 이미지 URL이 만료됨
- 이미지 파일이 삭제됨
- 이미지 서버 접근 불가

## 개선 사항

### 1. 이미지 다운로드 오류 처리 강화

#### 404 오류 처리

- **404 오류**: "이미지 파일을 찾을 수 없습니다 (404). 이미지 URL이 만료되었거나 삭제되었을 수 있습니다."

#### 403/401 오류 처리

- **접근 거부**: "이미지 접근이 거부되었습니다 (403). 권한이 없거나 파일이 삭제되었을 수 있습니다."

#### 타임아웃 오류 처리

- "이미지 다운로드 타임아웃: 이미지 서버에 연결할 수 없습니다."

### 2. 오류 메시지 사용자 친화적 개선

#### 배치 처리 오류 메시지

OCR 배치 처리에서 오류 발생 시:

1. **이미지 URL 만료/유효하지 않음**
   - "이미지 파일을 찾을 수 없습니다. 이미지 URL이 만료되었거나 삭제되었을 수 있습니다."

2. **이미지 접근 불가**
   - "이미지 접근 불가: 이미지에 접근할 수 없습니다. 권한이 없거나 파일이 삭제되었을 수 있습니다."

3. **네트워크 오류**
   - "이미지 다운로드 타임아웃: 이미지 서버에 연결할 수 없습니다. 네트워크 상태를 확인해주세요."

### 3. 로깅 개선

#### 상세 로그 정보

- 이미지 URL 도메인 확인
- 오류 유형별 상세 로그
- 원본 오류 메시지와 개선된 메시지 모두 기록

```typescript
console.error("[Cloud Run OCR] 이미지 404 오류:", {
  status,
  statusText,
  imageUrl: imageUrl.substring(0, 100) + "...",
  urlDomain,
});
```

## 변경된 파일

### 1. `lib/api/cloud-run-ocr.ts`

**개선 사항:**
- 이미지 다운로드 시 User-Agent 헤더 추가
- 404/403/401 오류에 대한 명확한 메시지
- 타임아웃 오류 처리
- 상세한 로깅

### 2. `app/actions/admin.ts`

**개선 사항:**
- 오류 메시지 사용자 친화적으로 변환
- 이미지 URL 만료/유효하지 않음 감지
- 접근 불가 오류 감지
- 타임아웃 오류 감지
- 상세한 오류 로깅 (원본 오류 + 개선된 메시지)

## 사용자 경험 개선

### 이전

```
OCR 처리 실패: Cloud Run OCR 처리 실패: 이미지 다운로드 실패: 404 Not Found
```

### 개선 후

```
이미지 파일을 찾을 수 없습니다. 이미지 URL이 만료되었거나 삭제되었을 수 있습니다.
```

## 해결 방법

### 사용자 권장 사항

1. **이미지 URL 만료 오류 발생 시**
   - 해당 기록의 이미지를 다시 업로드
   - 또는 OCR 처리를 건너뛰고 수동으로 텍스트 입력
   - 이미지를 Supabase Storage에 업로드하여 사용하는 것을 권장합니다

2. **배치 처리 실패 항목 재시도**
   - 실패한 항목만 선택적으로 재시도 가능
   - 하지만 이미지 URL이 만료된 경우 재시도해도 실패합니다

## 향후 개선 사항

### 1. 이미지 URL 유효성 사전 검사

배치 처리 시작 전에 이미지 URL의 유효성을 미리 확인하여, 유효하지 않은 URL은 제외하고 처리할 수 있습니다.

### 2. 자동 이미지 마이그레이션

외부 이미지 URL이 만료된 경우, 원본 이미지를 Supabase Storage로 자동 마이그레이션하는 기능을 추가할 수 있습니다.

### 3. 이미지 URL 만료 알림

이미지 URL이 곧 만료될 예정인 경우 사용자에게 알림을 제공할 수 있습니다.

## 참고 사항

- 외부 이미지 URL은 만료될 수 있습니다
- 이미지를 Supabase Storage에 저장하면 URL 만료 문제를 방지할 수 있습니다
- OCR 배치 처리 시 실패한 항목은 재시도할 수 있지만, 이미지 URL이 만료된 경우 재시도해도 실패합니다
