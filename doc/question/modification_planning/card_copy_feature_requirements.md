# 카드 복사 기능 재작업 요구사항

**작성일:** 2026년 1월 11일  
**우선순위:** 높음  
**작업 범위:** 카드 복사 기능 완전 재구현

---

## 1. 문제 정의

현재 카드 복사 기능에서 다음 문제들이 발생하고 있음:
- 표지 이미지가 클립보드에 복사된 이미지에서 흰색으로 표시되거나 보이지 않음
- 이미지 정보가 제대로 복사되지 않음
- 카드 레이아웃이 틀어지는 현상 발생

---

## 2. 기능 요구사항

### 2.1 핵심 요구사항

1. **정확한 이미지 복사**
   - 책 표지 이미지가 클립보드 복사된 이미지에서 **정확히 보여야 함**
   - 모든 이미지 요소가 원본 그대로 복사되어야 함
   - 이미지가 흰색이나 투명하게 나타나는 현상 없어야 함

2. **PC 버전 화면과 동일한 레이아웃**
   - 모바일/PC 관계없이 **PC 버전 화면 레이아웃**으로 복사
   - "공유" 버튼을 눌렀을 때 보이는 PC 버전 화면과 동일한 구조
   - 카드 레이아웃이 틀어지거나 변형되지 않아야 함

3. **크로스 플랫폼 호환성**
   - 모바일 디바이스에서도 정상 작동
   - PC 브라우저에서도 정상 작동
   - 디바이스에 관계없이 동일한 결과 생성

4. **성능 및 안정성**
   - 빠른 복사 속도 (3초 이내)
   - 안정적인 이미지 로딩
   - 에러 발생 시 적절한 사용자 피드백

---

## 3. 기술 요구사항

### 3.1 이미지 처리

1. **이미지 로딩 보장**
   - 모든 이미지(책 표지, 프로필 이미지 등)가 완전히 로드된 후 캡처
   - CORS 이슈 해결 (crossOrigin="anonymous" 설정)
   - Next.js Image 컴포넌트 최적화 URL 처리

2. **이미지 변환**
   - 필요 시 이미지를 base64로 변환하여 캡처
   - 외부 이미지 URL 프록시 또는 변환 처리
   - 이미지 로딩 실패 시 fallback 처리

3. **스타일 보존**
   - object-fit, aspect-ratio 등 이미지 스타일 유지
   - 배경색 및 테두리 스타일 유지
   - 그림자 효과 및 기타 시각적 요소 유지

### 3.2 캡처 로직

1. **html2canvas 옵션 최적화**
   ```javascript
   {
     scale: 2.5,                    // 고해상도 (PC 기준)
     useCORS: true,                 // CORS 활성화
     allowTaint: false,             // Taint 방지
     backgroundColor: null,         // 투명 배경
     logging: false,                // 로깅 비활성화
     imageTimeout: 15000,           // 이미지 로드 타임아웃 (15초)
     foreignObjectRendering: false, // SVG 렌더링 비활성화
     onclone: (doc, element) => {
       // 이미지 처리 로직
       // 스타일 강제 적용
       // 레이아웃 보정
     }
   }
   ```

2. **캡처 대상 요소**
   - PC 버전 레이아웃의 카드 요소만 캡처
   - 모바일에서도 PC 버전 레이아웃 사용
   - 불필요한 UI 요소(버튼 등) 제외

3. **캡처 프로세스**
   ```
   1. 사용자가 "카드 복사" 버튼 클릭
   2. UI 피드백 표시 (로딩 상태)
   3. 모든 이미지 로딩 확인 (최대 10초 대기)
   4. 필요 시 이미지 base64 변환
   5. PC 버전 레이아웃으로 html2canvas 실행
   6. Canvas를 Blob으로 변환
   7. 클립보드에 이미지 복사
   8. 성공 피드백 표시
   ```

### 3.3 클립보드 API

1. **Clipboard API 사용**
   ```javascript
   await navigator.clipboard.write([
     new ClipboardItem({
       'image/png': blob
     })
   ]);
   ```

2. **권한 처리**
   - 클립보드 권한 요청
   - 권한 거부 시 사용자 안내
   - 브라우저 호환성 체크

---

## 4. 구현 세부사항

### 4.1 파일 구조

**주요 파일:**
- `components/share/simple-share-dialog.tsx` - 공유 다이얼로그 (카드 복사 로직 포함)
- `components/share/share-note-card.tsx` - 카드 컴포넌트 (캡처 대상)

### 4.2 이미지 처리 전략

**전략 1: Base64 변환 (권장)**
- 캡처 전 모든 이미지를 base64로 변환
- CORS 및 Next.js Image 최적화 이슈 완전 해결
- 안정적이지만 메모리 사용량 증가

**전략 2: 프록시 서버**
- 외부 이미지를 자체 서버를 통해 프록시
- CORS 이슈 해결
- 서버 부하 고려 필요

**전략 3: unoptimized 이미지**
- Next.js Image 컴포넌트에 `unoptimized` 속성 추가
- 원본 URL 직접 사용
- 간단하지만 CORS 이슈 여전히 존재 가능

**최종 선택: 전략 1 (Base64 변환)**

### 4.3 구현 단계

**Phase 1: 이미지 로딩 및 변환**
1. ShareNoteCard 컴포넌트에 `data-original-src` 속성 추가
2. 이미지 로딩 확인 함수 구현
3. 이미지 base64 변환 함수 구현

**Phase 2: 캡처 로직 재작성**
1. html2canvas 옵션 최적화
2. onclone 콜백에서 이미지 처리
3. PC 버전 레이아웃 강제 적용

**Phase 3: 클립보드 복사**
1. Canvas to Blob 변환
2. Clipboard API 호출
3. 에러 처리 및 피드백

**Phase 4: 테스트 및 최적화**
1. 모바일 디바이스 테스트
2. 다양한 브라우저 테스트
3. 성능 최적화 (메모리, 속도)

---

## 5. 테스트 체크리스트

### 5.1 기능 테스트

- [ ] 책 표지 이미지가 정확히 복사됨
- [ ] 프로필 이미지가 정확히 복사됨
- [ ] 카드 레이아웃이 PC 버전과 동일함
- [ ] 텍스트 내용이 모두 포함됨
- [ ] 스타일(색상, 글꼴, 간격)이 유지됨

### 5.2 크로스 플랫폼 테스트

- [ ] Chrome (PC) - 정상 작동
- [ ] Chrome (모바일) - 정상 작동
- [ ] Safari (PC) - 정상 작동
- [ ] Safari (iOS) - 정상 작동
- [ ] Edge (PC) - 정상 작동

### 5.3 성능 테스트

- [ ] 복사 시간 3초 이내
- [ ] 메모리 사용량 적정 수준
- [ ] 이미지 로딩 실패 시 적절한 처리
- [ ] 연속 복사 시 안정적 작동

### 5.4 UX 테스트

- [ ] 로딩 상태 표시
- [ ] 성공 피드백 표시
- [ ] 에러 메시지 명확
- [ ] 버튼 클릭 중복 방지

---

## 6. 성공 기준

1. **이미지 정확도**: 모든 이미지가 원본과 동일하게 복사됨 (100%)
2. **레이아웃 일관성**: PC 버전 레이아웃과 동일함 (100%)
3. **크로스 플랫폼**: 모바일/PC 모두 정상 작동 (100%)
4. **성능**: 복사 시간 3초 이내 (95% 이상)
5. **안정성**: 에러 발생률 5% 미만

---

## 7. 참고 사항

### 7.1 현재 문제점

1. **이미지 CORS 이슈**
   - 외부 이미지 URL (예: Naver Shopping)에서 CORS 에러 발생
   - Next.js Image 최적화로 인한 URL 변경

2. **html2canvas 한계**
   - crossOrigin 설정만으로는 불충분
   - 이미지 로딩 타이밍 이슈

3. **레이아웃 문제**
   - 모바일과 PC 레이아웃 차이
   - 캡처 시 레이아웃 틀어짐

### 7.2 해결 방향

1. **이미지 pre-processing**
   - 캡처 전 모든 이미지를 base64로 변환
   - DOM에 data 속성으로 저장

2. **레이아웃 강제**
   - 캡처 시 PC 레이아웃 스타일 강제 적용
   - 불필요한 요소 숨김

3. **안정성 강화**
   - 이미지 로딩 재시도 로직
   - Fallback 이미지 준비
   - 명확한 에러 메시지

---

## 8. 구현 우선순위

1. **P0 (최우선)**: 이미지 정확히 복사
2. **P1 (필수)**: PC 레이아웃 동일 적용
3. **P2 (중요)**: 크로스 플랫폼 호환
4. **P3 (권장)**: 성능 최적화

---

## 9. 예상 작업 시간

- Phase 1 (이미지 처리): 30분
- Phase 2 (캡처 로직): 1시간
- Phase 3 (클립보드): 15분
- Phase 4 (테스트): 30분

**총 예상 시간: 2시간 15분**

---

## 10. 완료 조건

이 작업은 다음 조건이 모두 충족될 때 완료된 것으로 간주:

1. ✅ 책 표지 이미지가 클립보드 복사본에서 정확히 보임
2. ✅ 모든 이미지가 원본과 동일하게 복사됨
3. ✅ 카드 레이아웃이 PC 버전과 100% 동일
4. ✅ 모바일과 PC에서 모두 정상 작동
5. ✅ 복사 시간 3초 이내
6. ✅ 안정적으로 작동 (에러율 5% 미만)

---

**이 문서를 기반으로 카드 복사 기능을 완전히 재구현합니다.**
