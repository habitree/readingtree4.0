# OCR API 키 제한사항 수정 가이드

## 문제 상황

서버 사이드에서 Vision API를 호출할 때 다음 에러가 발생합니다:

```
"message": "Requests from referer <empty> are blocked.",
"reason": "API_KEY_HTTP_REFERRER_BLOCKED"
```

## 원인

- **서버 사이드 호출**: Next.js 서버에서 Vision API를 호출할 때는 Referer 헤더가 없습니다
- **웹사이트 제한사항**: API 키가 웹사이트 제한사항으로 설정되어 있어 Referer가 없는 요청을 차단합니다
- **웹사이트 제한사항은 클라이언트 사이드 요청에만 적용됩니다**

## 해결 방법

### 방법 1: API 키 제한사항 제거 (권장 - 개발 환경)

**서버 사이드 호출이므로 웹사이트 제한사항이 필요 없습니다.**

1. Google Cloud Console → API 및 서비스 → 사용자 인증 정보
2. API 키 클릭
3. **"웹사이트 제한사항"** 섹션에서:
   - **"키 제한 안함"** 선택
   - 또는 **"IP 주소"** 선택 (서버 IP 주소 추가)

**장점:**
- 서버 사이드 호출에 적합
- 설정이 간단

**단점:**
- API 키가 노출되면 모든 곳에서 사용 가능 (서버 사이드이므로 상대적으로 안전)

### 방법 2: IP 주소 제한사항 사용

1. Google Cloud Console → API 및 서비스 → 사용자 인증 정보
2. API 키 클릭
3. **"애플리케이션 제한사항"**에서:
   - **"IP 주소"** 선택
   - 서버 IP 주소 추가:
     - 로컬 개발: `127.0.0.1` 또는 `localhost`
     - Vercel 배포: Vercel의 IP 주소 범위 (또는 제한 없음)

**장점:**
- 보안 강화
- 서버 사이드 호출에 적합

**단점:**
- IP 주소가 변경되면 업데이트 필요
- Vercel은 동적 IP를 사용하므로 제한이 어려울 수 있음

### 방법 3: 서비스 계정 사용 (프로덕션 권장)

서비스 계정을 사용하면 API 키 제한사항 문제를 완전히 해결할 수 있습니다.

1. Google Cloud Console → IAM 및 관리자 → 서비스 계정
2. 서비스 계정 생성
3. Vision API 권한 부여
4. JSON 키 다운로드
5. 환경 변수 설정:
   ```env
   GOOGLE_APPLICATION_CREDENTIALS=./path/to/service-account-key.json
   ```
   또는
   ```env
   GOOGLE_SERVICE_ACCOUNT_JSON={"type":"service_account",...}
   ```

**장점:**
- 가장 안전한 방법
- 제한사항 문제 없음
- 프로덕션 환경에 적합

**단점:**
- 설정이 복잡함
- 서비스 계정 관리 필요

## 빠른 해결 (개발 환경)

**지금 바로 해결하려면:**

1. Google Cloud Console → API 및 서비스 → 사용자 인증 정보
2. API 키 클릭
3. **"애플리케이션 제한사항"** 섹션에서:
   - **"키 제한 안함"** 선택
4. 저장

**참고:** 
- 개발 환경에서는 "키 제한 안함"으로 설정해도 서버 사이드에서만 사용하므로 상대적으로 안전합니다
- 프로덕션 환경에서는 서비스 계정 사용을 권장합니다

## 확인 방법

설정 변경 후:

1. **5분 대기** (설정 적용 시간)
2. **서버 재시작** (환경 변수 재로드)
3. **다시 테스트** (필사 이미지 업로드)
4. **터미널 로그 확인**:
   - `[Vision API] Vision API 호출 성공` 메시지 확인
   - 에러가 없어야 함

## 현재 설정 확인

현재 API 키 설정:
- ✅ API 제한사항: Cloud Vision API (올바름)
- ❌ 웹사이트 제한사항: `http://localhost:3000/*`, `https://*.vercel.app/*` (서버 사이드 호출에는 적용 안 됨)

**문제:** 서버 사이드 호출에는 Referer가 없어서 웹사이트 제한사항이 차단하고 있습니다.

**해결:** 웹사이트 제한사항을 제거하거나 IP 주소 제한으로 변경하세요.

