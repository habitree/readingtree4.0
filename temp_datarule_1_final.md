---
alwaysApply: true
---

## [Data Model Governance]

# 프로젝트 데이터 구조 규칙 - 1. 거버넌스 및 스키마 (Governance & Schema)

**작성일:** 2025년 1월
**프로젝트:** Habitree Reading Hub v4.0.0
**버전:** 2.1 (분리 개정판)
**적용 범위:** 데이터베이스 설계, 스키마 관리, 문서화

**참고:**
- 구현 및 코드 패턴 규칙은 `datarule_2.md`를 참조하세요.
- 상세 마이그레이션 규칙은 `.cursor/rules/migration_rule.mdc`를 참조하세요.

---

## 1. 규칙 개요

### 1.1 규칙의 목적
이 문서는 **데이터 구조의 무결성과 일관성**을 유지하기 위한 상위 수준의 거버넌스 규칙을 정의합니다. 데이터 모델링 원칙을 준수하지 않으면 기술 부채가 급격히 증가합니다.

### 1.2 핵심 원칙
- ✅ **단일 기준(Single Source of Truth)**: 모든 데이터 구조는 문서(`DATA_MODEL.md`)에 정의된 대로만 존재합니다.
- ✅ **문서화 필수**: 코드를 변경하기 전에 데이터 모델 문서를 먼저 수정해야 합니다.
- ✅ **중복 금지**: 동일한 도메인 개념을 위한 중복 테이블 생성을 금지합니다.

---

## 2. 데이터 모델 단일 기준

### 2.1 단일 기준 문서
데이터베이스 구조의 유일한 기준 문서는 다음 파일입니다:
**`doc/database/DATA_MODEL.md`**

모든 테이블, 컬럼, 관계, 권한, RLS 정책은 이 문서에 정의되어야 하며, 실제 DB 스키마는 이 문서를 완벽하게 반영해야 합니다.

### 2.2 테이블 정의 필수 사항
모든 테이블 정의 시 다음 항목이 필수적으로 포함되어야 합니다:
1. **목적 정의**: 이 테이블이 왜 필요한지 한 문장으로 설명
2. **소유 구조**: `auth.users`와의 관계 및 소유권 기준
3. **접근 제어(RLS)**: 누가 읽고 쓸 수 있는지에 대한 정책 의도

---

## 3. 스키마 변경 및 마이그레이션

### 3.1 변경 절차
1.  **설계**: `DATA_MODEL.md` 수정
2.  **구현**: 마이그레이션 SQL 파일 작성
3.  **반영**: 코드 반영 (API/UI)

### 3.2 마이그레이션 파일 규칙
- **경로**: `doc/database/` (향후 `migrations/` 이동 예정)
- **파일명**: `migration-YYYYMMDDHHmm__<기능명>__<변경내용>.sql`
- **Idempotent 원칙**: `IF NOT EXISTS` 등을 사용하여 반복 실행 가능하도록 작성

### 3.3 UUID 생성
새로운 테이블의 기본 키는 반드시 **`gen_random_uuid()`**를 사용합니다.

---

## 4. 데이터 무결성 원칙

### 4.1 단일 테이블 원칙
하나의 개념은 하나의 테이블로만 존재해야 합니다. 중복 테이블은 절대 허용되지 않습니다.

### 4.2 소유자 참조
모든 사용자 관련 외래 키는 Supabase Auth의 **`auth.users(id)`**를 참조해야 합니다.

```sql
user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE
```

### 4.3 외래 키 및 CASCADE
관계가 명확한 경우 `ON DELETE CASCADE`를 명시하여 데이터 고아(Orphan) 발생을 방지합니다.

---

## 5. 변경 사항 문서화 체크리스트
스키마 변경 시 다음 세 가지가 동기화되었는지 반드시 확인하세요:
1.  `doc/database/DATA_MODEL.md` (설계)
2.  `types/database.ts` (타입)
3.  마이그레이션 SQL 파일 (DB)

---

## 6. 필수 폴더 및 파일 구조
```
doc/
└─ database/
   ├─ DATA_MODEL.md      (스키마 기준)
   └─ migration-*.sql    (변경 이력)
types/
└─ database.ts          (타입 정의)
```
